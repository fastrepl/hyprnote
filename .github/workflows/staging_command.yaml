on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

concurrency:
  group: staging-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  permission:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    steps:
      - id: check
        run: |
          case "${{ github.event.comment.user.login }}" in
            yujonglee|ComputelessComputer) echo "allowed=true" >> $GITHUB_OUTPUT ;;
            *) echo "allowed=false" >> $GITHUB_OUTPUT ;;
          esac
  parse_command:
    needs: permission
    if: needs.permission.outputs.allowed == 'true'
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.parse.outputs.valid }}
      ref: ${{ steps.resolve_ref.outputs.ref }}
      sha: ${{ steps.resolve_ref.outputs.sha }}
      branch: ${{ steps.resolve_ref.outputs.branch }}
      needs_cleanup: ${{ steps.resolve_ref.outputs.needs_cleanup }}
      notify_success: ${{ steps.parse.outputs.notify_success }}
      notify_error: ${{ steps.parse.outputs.notify_error }}
    steps:
      - id: parse
        shell: bash
        env:
          COMMENT: ${{ github.event.comment.body }}
        run: |
          # /staging [ref] [--notify-success user1,user2] [--notify-error user1,user2]
          [[ "$COMMENT" =~ (^|[[:space:]])/staging($|[[:space:]]) ]] || { echo "valid=false" >> $GITHUB_OUTPUT; exit 0; }
          echo "valid=true" >> $GITHUB_OUTPUT

          [[ "$COMMENT" =~ /staging[[:space:]]+([a-zA-Z0-9_.][a-zA-Z0-9_./-]*)($|[[:space:]]) ]] && echo "ref=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          [[ "$COMMENT" =~ --notify-success[[:space:]]+([a-zA-Z0-9_,]+) ]] && echo "notify_success=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          [[ "$COMMENT" =~ --notify-error[[:space:]]+([a-zA-Z0-9_,]+) ]] && echo "notify_error=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
      - if: steps.parse.outputs.valid == 'true'
        id: resolve_ref
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          EXPLICIT_REF="${{ steps.parse.outputs.ref }}"
          IS_PR="${{ github.event.issue.pull_request }}"

          output_ref() {
            echo "ref=$1" >> $GITHUB_OUTPUT
            echo "sha=$2" >> $GITHUB_OUTPUT
            echo "branch=$3" >> $GITHUB_OUTPUT
            echo "needs_cleanup=$4" >> $GITHUB_OUTPUT
          }

          if [ -z "$EXPLICIT_REF" ] && [ -n "$IS_PR" ]; then
            PR_DATA=$(gh api repos/$REPO/pulls/${{ github.event.issue.number }})
            BRANCH=$(echo "$PR_DATA" | jq -r '.head.ref')
            SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
            output_ref "$BRANCH" "$SHA" "$BRANCH" "false"
          elif [ -n "$EXPLICIT_REF" ]; then
            SHA=$(gh api repos/$REPO/commits/$EXPLICIT_REF --jq '.sha')
            if gh api repos/$REPO/git/refs/heads/$EXPLICIT_REF --jq '.ref' >/dev/null 2>&1; then
              output_ref "$EXPLICIT_REF" "$SHA" "$EXPLICIT_REF" "false"
            else
              TEMP_BRANCH="staging-temp-${SHA:0:8}"
              GH_TOKEN=${{ secrets.PAT_TOKEN }} gh api repos/$REPO/git/refs -f ref="refs/heads/$TEMP_BRANCH" -f sha="$SHA"
              for i in {1..10}; do
                gh api repos/$REPO/git/refs/heads/$TEMP_BRANCH --jq '.ref' >/dev/null 2>&1 && break
                echo "Waiting for branch to propagate... ($i/10)"
                sleep 2
              done
              output_ref "$EXPLICIT_REF" "$SHA" "$TEMP_BRANCH" "true"
            fi
          else
            echo "No ref provided and not in a PR context"
            exit 1
          fi

  trigger_build:
    needs: [permission, parse_command]
    if: needs.permission.outputs.allowed == 'true' && needs.parse_command.outputs.valid == 'true'
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.trigger.outputs.run_id }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
      SHA: ${{ needs.parse_command.outputs.sha }}
      BRANCH: ${{ needs.parse_command.outputs.branch }}
    steps:
      - uses: actions/checkout@v4
      - run: gh api repos/$REPO/issues/comments/${{ github.event.comment.id }}/reactions -f content='eyes' --silent
      - run: |
          gh run list --repo $REPO --workflow=desktop_cd.yaml --status=in_progress --status=queued \
            --json databaseId,headSha --jq ".[] | select(.headSha | startswith(\"$SHA\") or \"$SHA\" | startswith(.headSha)) | .databaseId" | \
          xargs -I {} gh run cancel {} --repo $REPO || true
      - id: trigger
        run: |
          gh workflow run desktop_cd.yaml --repo $REPO --ref "$BRANCH" -f channel=staging
          for i in {1..60}; do
            sleep 5
            RUN_ID=$(gh run list --workflow=desktop_cd.yaml --commit="$SHA" --status=in_progress --status=queued --json databaseId --jq '.[0].databaseId // empty')
            [ -n "$RUN_ID" ] && { echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT; exit 0; }
          done
          echo "Failed to get run ID"
          exit 1
      - run: gh run watch ${{ steps.trigger.outputs.run_id }} --exit-status
      - if: always() && needs.parse_command.outputs.needs_cleanup == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: gh api repos/$REPO/git/refs/heads/$BRANCH -X DELETE || true

  comment_result:
    needs: [permission, parse_command, trigger_build]
    if: always() && needs.permission.outputs.allowed == 'true' && needs.parse_command.outputs.valid == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - run: |
          REF="${{ needs.parse_command.outputs.ref }}"
          RESULT="${{ needs.trigger_build.result }}"
          RUN_ID="${{ needs.trigger_build.outputs.run_id }}"

          if [ "$RESULT" == "success" ]; then
            NOTIFY="${{ needs.parse_command.outputs.notify_success }}"
            EMOJI="üöÄ"
            TITLE="Staging Build Ready"
            LINK="[Download artifacts](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)"
          else
            NOTIFY="${{ needs.parse_command.outputs.notify_error }}"
            EMOJI="‚ùå"
            TITLE="Staging Build Failed"
            if [ -n "$RUN_ID" ]; then
              LINK="[View logs](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)"
            else
              LINK="Failed to trigger staging build. [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            fi
          fi

          MENTIONS=""
          if [ -n "$NOTIFY" ]; then
            MENTIONS=$(echo "$NOTIFY" | tr ',' '\n' | sed 's/^/@/' | tr '\n' ' ')
          fi

          BODY="$EMOJI $TITLE
          - Ref: \`$REF\`
          - $LINK
          $MENTIONS"
          BODY=$(echo "$BODY" | sed 's/^[[:space:]]*//')

          if [ -n "${{ github.event.issue.pull_request }}" ]; then
            gh pr comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body "$BODY"
          else
            gh issue comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body "$BODY"
          fi
