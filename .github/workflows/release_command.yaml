on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

concurrency:
  group: release-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  permission:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        uses: ./.github/actions/check-permission
        with:
          user: ${{ github.event.comment.user.login }}
          allowed-users: yujonglee|ComputelessComputer

  parse_command:
    needs: permission
    if: needs.permission.outputs.allowed == 'true'
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.parse.outputs.valid }}
      channel: ${{ steps.parse.outputs.channel }}
      merged: ${{ steps.resolve_ref.outputs.merged }}
      merge_sha: ${{ steps.resolve_ref.outputs.merge_sha }}
      branch: ${{ steps.resolve_ref.outputs.branch }}
      needs_cleanup: ${{ steps.resolve_ref.outputs.needs_cleanup }}
    steps:
      - id: parse
        shell: bash
        env:
          COMMENT: ${{ github.event.comment.body }}
        run: |
          if [[ "$COMMENT" =~ (^|[[:space:]])/nightly($|[[:space:]]) ]]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "channel=nightly" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" =~ (^|[[:space:]])/stable($|[[:space:]]) ]]; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "channel=stable" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
      - if: steps.parse.outputs.valid == 'true'
        id: resolve_ref
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          IS_PR="${{ github.event.issue.pull_request }}"

          if [ -z "$IS_PR" ]; then
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_DATA=$(gh api repos/$REPO/pulls/${{ github.event.issue.number }})
          MERGED=$(echo "$PR_DATA" | jq -r '.merged')

          if [ "$MERGED" != "true" ]; then
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          MERGE_SHA=$(echo "$PR_DATA" | jq -r '.merge_commit_sha')
          TEMP_BRANCH="release-temp-${MERGE_SHA:0:8}"

          GH_TOKEN=${{ secrets.PAT_TOKEN }} gh api repos/$REPO/git/refs -f ref="refs/heads/$TEMP_BRANCH" -f sha="$MERGE_SHA"

          echo "merged=true" >> $GITHUB_OUTPUT
          echo "merge_sha=$MERGE_SHA" >> $GITHUB_OUTPUT
          echo "branch=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          echo "needs_cleanup=true" >> $GITHUB_OUTPUT

  trigger_release:
    needs: [permission, parse_command]
    if: needs.permission.outputs.allowed == 'true' && needs.parse_command.outputs.valid == 'true' && needs.parse_command.outputs.merged == 'true'
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ steps.trigger.outputs.run_id }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4
      - run: gh api repos/$REPO/issues/comments/${{ github.event.comment.id }}/reactions -f content='rocket' --silent
      - id: trigger
        uses: ./.github/actions/trigger-workflow
        with:
          workflow: desktop_cd.yaml
          ref: ${{ needs.parse_command.outputs.branch }}
          channel: ${{ needs.parse_command.outputs.channel }}
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          max_attempts: "10"

  comment_result:
    needs: [permission, parse_command, trigger_release]
    if: always() && needs.permission.outputs.allowed == 'true' && needs.parse_command.outputs.valid == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - id: build_data
        run: |
          CHANNEL="${{ needs.parse_command.outputs.channel }}"
          MERGED="${{ needs.parse_command.outputs.merged }}"
          MERGE_SHA="${{ needs.parse_command.outputs.merge_sha }}"
          RUN_ID="${{ needs.trigger_release.outputs.run_id }}"

          if [ "$MERGED" != "true" ]; then
            echo "success=false" >> $GITHUB_OUTPUT
            echo "title=Cannot trigger $CHANNEL release - PR must be merged first" >> $GITHUB_OUTPUT
            echo "data={\"Channel\": \"\`$CHANNEL\`\"}" >> $GITHUB_OUTPUT
          elif [ -n "$RUN_ID" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "title=$CHANNEL release triggered" >> $GITHUB_OUTPUT
            DATA=$(jq -n \
              --arg channel "\`$CHANNEL\`" \
              --arg sha "\`${MERGE_SHA:0:8}\`" \
              --arg run "[View run](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)" \
              '{Channel: $channel, "Merge commit": $sha, Run: $run}')
            echo "data=$DATA" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "title=Failed to trigger $CHANNEL release" >> $GITHUB_OUTPUT
            DATA=$(jq -n \
              --arg channel "\`$CHANNEL\`" \
              --arg logs "[View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
              '{Channel: $channel, Logs: $logs}')
            echo "data=$DATA" >> $GITHUB_OUTPUT
          fi
      - uses: ./.github/actions/comment-result
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          issue_number: ${{ github.event.issue.number }}
          success: ${{ steps.build_data.outputs.success }}
          title: ${{ steps.build_data.outputs.title }}
          data: ${{ steps.build_data.outputs.data }}
      - if: needs.parse_command.outputs.needs_cleanup == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: gh api repos/${{ github.repository }}/git/refs/heads/${{ needs.parse_command.outputs.branch }} -X DELETE || true
