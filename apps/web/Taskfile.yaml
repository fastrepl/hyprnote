version: "3"

tasks:
  deploy:
    dir: .
    cmds:
      - netlify deploy --prod

  env-sample:
    dir: .
    cmds:
      - sed -E '/^[A-Z_][A-Z0-9_]*=/s/=.*/=""/' .env > .env.sample

  env-prod:
    dir: .
    cmds:
      - netlify env:import .env.prod
      # - |
      #     grep -v '^#' ./.env.prod | grep '=' | while IFS='=' read -r key value; do
      #       netlify env:set "$key" "$value" --context production --secret
      #     done

  supabase:
    dir: .
    cmds:
      - supabase {{.CLI_ARGS}}

  supabase-env:
    dir: .
    cmds:
      - supabase secrets set --env-file ./supabase/functions/.env --project-ref ijoptyyjrfqwaqhyxkxj

  supabase-stop:
    dir: .
    cmds:
      - supabase stop

  supabase-start:
    dir: .
    cmds:
      - task: supabase-start:capture
      - task: supabase-start:merge
      - rm -f .supabase/generated.env

  supabase-start:capture:
    internal: true
    dir: .
    cmds:
      - |
          bash <<'EOF'
          set -euo pipefail

          generated_env_file=".supabase/generated.env"
          output_file=$(mktemp)
          cleanup() {
            rm -f "$output_file"
          }
          trap cleanup EXIT

          mkdir -p "$(dirname "$generated_env_file")"

          set +e
          supabase start 2>&1 | tee "$output_file"
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          if [ "$EXIT_CODE" -ne 0 ]; then
            exit "$EXIT_CODE"
          fi

          awk '
            /API URL:/ { print "SUPABASE_URL=\"" $NF "\"" }
            /GraphQL URL:/ { print "SUPABASE_GRAPHQL_URL=\"" $NF "\"" }
            /S3 Storage URL:/ { print "SUPABASE_STORAGE_URL=\"" $NF "\"" }
            /Database URL:/ { print "DATABASE_URL=\"" $NF "\"" }
            /Studio URL:/ { print "SUPABASE_STUDIO_URL=\"" $NF "\"" }
            /Publishable key:/ { print "SUPABASE_ANON_KEY=\"" $NF "\"" }
            /Secret key:/ { print "SUPABASE_SERVICE_ROLE_KEY=\"" $NF "\"" }
            /S3 Access Key:/ { print "S3_ACCESS_KEY=\"" $NF "\"" }
            /S3 Secret Key:/ { print "S3_SECRET_KEY=\"" $NF "\"" }
            /S3 Region:/ { print "S3_REGION=\"" $NF "\"" }
          ' "$output_file" > "$generated_env_file"
          EOF

  supabase-start:merge:
    internal: true
    dir: .
    cmds:
      - |
          bash <<'EOF'
          set -euo pipefail

          env_target=".env"
          generated_env_file=".supabase/generated.env"

          if [ ! -f "$generated_env_file" ]; then
            echo "Generated env file not found: $generated_env_file" >&2
            exit 1
          fi

          if [ ! -f "$env_target" ]; then
            cp "$generated_env_file" "$env_target"
            exit 0
          fi

          merged_env_file=$(mktemp)

          awk -v new_file="$generated_env_file" '
            BEGIN {
              while ((getline line < new_file) > 0) {
                if (line ~ /^[[:space:]]*$/ || line ~ /^[[:space:]]*#/) continue
                sep = index(line, "=")
                if (sep == 0) continue
                key = substr(line, 1, sep - 1)
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", key)
                value = substr(line, sep + 1)
                new_values[key] = value
              }
              close(new_file)
            }
            {
              line = $0
              if (line ~ /^[[:space:]]*$/ || line ~ /^[[:space:]]*#/) {
                print line
                next
              }
              sep = index(line, "=")
              if (sep == 0) {
                print line
                next
              }
              key = substr(line, 1, sep - 1)
              gsub(/^[[:space:]]+|[[:space:]]+$/, "", key)
              if (key in new_values) {
                print key "=" new_values[key]
                used[key] = 1
              } else {
                print line
              }
            }
            END {
              for (key in new_values) {
                if (!(key in used)) {
                  print key "=" new_values[key]
                }
              }
            }
          ' "$env_target" > "$merged_env_file"

          mv "$merged_env_file" "$env_target"
          EOF
