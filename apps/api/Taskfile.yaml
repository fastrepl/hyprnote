version: "3"

tasks:
  deploy:
    cmds:
      - fly deploy --config apps/api/fly.toml

  env-sample:
    dir: .
    cmds:
      - sed -E '/^[A-Z_][A-Z0-9_]*=/s/=.*/=""/' .env > .env.sample

  env-prod:
    dir: .
    cmds:
      - |
          bash <<'EOF'
          set -euo pipefail

          env_file=".env.prod"

          if [ ! -f "$env_file" ]; then
            exit 1
          fi

          awk '
            /^[[:space:]]*$/ { next }
            /^[[:space:]]*#/ { next }
            {
              sub(/^[[:space:]]+/, "", $0)
              print
            }
          ' "$env_file" | fly secrets import
          EOF
