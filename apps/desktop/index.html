<!doctype html>
<html lang="en">
  <head>
    <!-- <script src="https://unpkg.com/react-scan/dist/auto.global.js"></script> -->
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Hyprnote</title>
    <style>
      html, body, #root {
        background: transparent !important;
        background-color: transparent !important;
      }
    </style>
    <!-- Polyfill __TAURI_INTERNALS__ for browser context (hypr-core server) and iframe context (extension host). -->
    <script>
      (function() {
        var isIframeContext = window.self !== window.top;
        var isTauriContext = window.__TAURI_INTERNALS__ !== undefined;

        if (isTauriContext) return;

        var HYPR_CORE_URL = 'http://127.0.0.1:9527';
        var eventListeners = {};
        var callbackId = 0;

        window.__TAURI_INTERNALS__ = {
          _metadata: {
            currentWindow: { label: isIframeContext ? "iframe" : "main", kind: "WebviewWindow" },
            currentWebview: { label: isIframeContext ? "iframe" : "main", windowLabel: isIframeContext ? "iframe" : "main" },
            windows: [],
            webviews: []
          },
          invoke: function(cmd, args) {
            if (isIframeContext) {
              return Promise.reject(new Error("Tauri not available in iframe"));
            }
            return fetch(HYPR_CORE_URL + '/invoke', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cmd: cmd, args: args || {} })
            })
            .then(function(res) { return res.json(); })
            .then(function(response) {
              if (response.error) {
                throw new Error(response.error);
              }
              return response.data;
            });
          },
          transformCallback: function(callback, once) {
            var id = callbackId++;
            eventListeners[id] = { callback: callback, once: once };
            return id;
          },
          convertFileSrc: function(path) { return path; }
        };

        if (!isIframeContext) {
          console.log('[hypr-core] Polyfill active - using HTTP backend at ' + HYPR_CORE_URL);
        }
      })();
    </script>
  </head>
  <body spellcheck="false">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
