name: changelog_trigger

on:
  push:
    branches:
      - main
    paths:
      - "apps/web/content/changelog/*.mdx"

jobs:
  trigger-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: detect
        run: |
          set -e
          ADDED_FILES=$(git diff --name-status --diff-filter=A HEAD~1 HEAD -- "apps/web/content/changelog/*.mdx" | awk '{print $2}')
          if [[ -z "$ADDED_FILES" ]]; then
            echo "No new changelog files added"
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          FILE=$(echo "$ADDED_FILES" | head -n1)
          BASENAME=$(basename "$FILE" .mdx)
          echo "Detected new changelog: $BASENAME"
          if [[ "$BASENAME" == *"nightly"* ]]; then
            echo "channel=nightly" >> $GITHUB_OUTPUT
          else
            echo "channel=stable" >> $GITHUB_OUTPUT
          fi
          echo "should_trigger=true" >> $GITHUB_OUTPUT
      - if: steps.detect.outputs.should_trigger == 'true'
        run: |
          set -e
          curl -f -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/desktop_cd.yaml/dispatches" \
            -d '{"ref":"main","inputs":{"channel":"${{ steps.detect.outputs.channel }}"}}'
