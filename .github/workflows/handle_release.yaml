on:
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
      publish:
        required: false
        type: boolean
        default: true
      issue_number:
        required: true
        type: number
      comment_id:
        required: true
        type: number

concurrency:
  group: release-${{ inputs.issue_number }}
  cancel-in-progress: false

jobs:
  resolve-and-trigger:
    runs-on: ubuntu-latest
    outputs:
      data: ${{ steps.result.outputs.data }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - run: git fetch --tags --force
      - uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ inputs.comment_id }}
          reaction: eyes
      - id: resolve
        run: |
          if [ "${{ inputs.channel }}" == "stable" ]; then
            NIGHTLY_TAG=$(git tag -l 'desktop_v*-nightly.*' --sort=-v:refname | head -n1)
            if [ -z "$NIGHTLY_TAG" ]; then
              echo "resolved=false" >> $GITHUB_OUTPUT
              echo "error=No nightly release tag found" >> $GITHUB_OUTPUT
              exit 0
            fi

            TAG_SHA=$(git rev-list -n 1 "$NIGHTLY_TAG")
            TEMP_BRANCH="release-temp-${TAG_SHA:0:8}"

            GH_TOKEN=${{ secrets.YUJONGLEE_GITHUB_TOKEN_REPO }} gh api repos/$REPO/git/refs -f ref="refs/heads/$TEMP_BRANCH" -f sha="$TAG_SHA"

            echo "resolved=true" >> $GITHUB_OUTPUT
            echo "target_sha=$TAG_SHA" >> $GITHUB_OUTPUT
            echo "branch=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          else
            PR_DATA=$(gh api repos/$REPO/pulls/${{ inputs.issue_number }} 2>/dev/null) || {
              echo "resolved=false" >> $GITHUB_OUTPUT
              echo "error=Not a pull request or PR not found" >> $GITHUB_OUTPUT
              exit 0
            }

            MERGED=$(echo "$PR_DATA" | jq -r '.merged')
            if [ "$MERGED" != "true" ]; then
              echo "resolved=false" >> $GITHUB_OUTPUT
              echo "error=PR must be merged first" >> $GITHUB_OUTPUT
              exit 0
            fi

            MERGE_SHA=$(echo "$PR_DATA" | jq -r '.merge_commit_sha')
            TEMP_BRANCH="release-temp-${MERGE_SHA:0:8}"

            GH_TOKEN=${{ secrets.YUJONGLEE_GITHUB_TOKEN_REPO }} gh api repos/$REPO/git/refs -f ref="refs/heads/$TEMP_BRANCH" -f sha="$MERGE_SHA"

            echo "resolved=true" >> $GITHUB_OUTPUT
            echo "target_sha=$MERGE_SHA" >> $GITHUB_OUTPUT
            echo "branch=$TEMP_BRANCH" >> $GITHUB_OUTPUT
          fi
      - if: steps.resolve.outputs.resolved == 'true'
        id: trigger
        uses: ./.github/actions/trigger-workflow
        with:
          workflow: desktop_cd.yaml
          ref: ${{ steps.resolve.outputs.branch }}
          channel: ${{ inputs.channel }}
          publish: ${{ inputs.publish }}
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          max_attempts: "10"
      - id: result
        run: |
          CHANNEL="${{ inputs.channel }}"
          RESOLVED="${{ steps.resolve.outputs.resolved }}"
          TARGET_SHA="${{ steps.resolve.outputs.target_sha }}"
          ERROR="${{ steps.resolve.outputs.error }}"
          RUN_ID="${{ steps.trigger.outputs.run_id }}"

          if [ "$RESOLVED" != "true" ]; then
            DATA=$(jq -cn \
              --arg channel "\`$CHANNEL\`" \
              --arg sha "-" \
              --arg status "$ERROR" \
              '[{header: "Channel", value: $channel}, {header: "Commit", value: $sha}, {header: "Status", value: $status}]')
          elif [ -n "$RUN_ID" ]; then
            DATA=$(jq -cn \
              --arg channel "\`$CHANNEL\`" \
              --arg sha "[\`${TARGET_SHA:0:8}\`](https://github.com/$REPO/commit/$TARGET_SHA)" \
              --arg status "[View](https://github.com/$REPO/actions/runs/$RUN_ID)" \
              '[{header: "Channel", value: $channel}, {header: "Commit", value: $sha}, {header: "Status", value: $status}]')
          else
            DATA=$(jq -cn \
              --arg channel "\`$CHANNEL\`" \
              --arg sha "[\`${TARGET_SHA:0:8}\`](https://github.com/$REPO/commit/$TARGET_SHA)" \
              --arg status "[Logs](https://github.com/$REPO/actions/runs/${{ github.run_id }})" \
              '[{header: "Channel", value: $channel}, {header: "Commit", value: $sha}, {header: "Status", value: $status}]')
          fi
          echo "data=$DATA" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/comment-result
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          issue_number: ${{ inputs.issue_number }}
          data: ${{ steps.result.outputs.data }}
      - if: steps.resolve.outputs.resolved == 'true'
        env:
          GH_TOKEN: ${{ secrets.YUJONGLEE_GITHUB_TOKEN_REPO }}
        run: gh api repos/${{ github.repository }}/git/refs/heads/${{ steps.resolve.outputs.branch }} -X DELETE || true
