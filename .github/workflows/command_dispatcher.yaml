on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write

jobs:
  check-permission:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.permission.outputs.allowed }}
    steps:
      - uses: actions/checkout@v4
      - id: permission
        uses: ./.github/actions/check-permission
        with:
          user: ${{ github.event.comment.user.login }}
          allowed-users: yujonglee|ComputelessComputer

  handle-nightly:
    needs: check-permission
    if: needs.check-permission.outputs.allowed == 'true' && contains(github.event.comment.body, '/nightly')
    uses: ./.github/workflows/handle_release.yaml
    with:
      channel: nightly
      issue_number: ${{ github.event.issue.number }}
      comment_id: ${{ github.event.comment.id }}
    secrets: inherit

  handle-stable:
    needs: check-permission
    if: needs.check-permission.outputs.allowed == 'true' && contains(github.event.comment.body, '/stable')
    uses: ./.github/workflows/handle_release.yaml
    with:
      channel: stable
      issue_number: ${{ github.event.issue.number }}
      comment_id: ${{ github.event.comment.id }}
    secrets: inherit

  parse-staging-ref:
    needs: check-permission
    if: needs.check-permission.outputs.allowed == 'true' && contains(github.event.comment.body, '/staging')
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.parse.outputs.ref }}
    steps:
      - id: parse
        env:
          COMMENT: ${{ github.event.comment.body }}
        run: |
          if [[ "$COMMENT" =~ /staging[[:space:]]+([a-zA-Z0-9_.][a-zA-Z0-9_./-]*)($|[[:space:]]) ]]; then
            echo "ref=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          fi

  handle-staging:
    needs: [check-permission, parse-staging-ref]
    if: needs.check-permission.outputs.allowed == 'true' && contains(github.event.comment.body, '/staging')
    uses: ./.github/workflows/handle_staging.yaml
    with:
      ref: ${{ needs.parse-staging-ref.outputs.ref }}
      issue_number: ${{ github.event.issue.number }}
      comment_id: ${{ github.event.comment.id }}
    secrets: inherit

  handle-update:
    needs: check-permission
    if: needs.check-permission.outputs.allowed == 'true' && contains(github.event.comment.body, '/update')
    uses: ./.github/workflows/handle_update.yaml
    with:
      issue_number: ${{ github.event.issue.number }}
      comment_id: ${{ github.event.comment.id }}
    secrets: inherit
