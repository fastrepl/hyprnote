on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-linux:
    runs-on: depot-ubuntu-24.04-8
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: ./.github/actions/install_desktop_deps
        with:
          target: linux
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - uses: ./.github/actions/pnpm_install
      - run: pnpm -F ui build
      - run: pnpm -F desktop tauri build --no-bundle --target x86_64-unknown-linux-gnu --config ./src-tauri/tauri.conf.staging.json --features devtools
        env:
          CI: false
      - uses: ./.github/actions/desktop-e2e-linux
        with:
          channel: staging
          target_triple: x86_64-unknown-linux-gnu

  e2e-macos:
    runs-on: depot-macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: ./.github/actions/install_desktop_deps
        with:
          target: macos
      - uses: ./.github/actions/rust_install
        with:
          platform: macos
      - uses: ./.github/actions/pnpm_install
      - run: pnpm -F ui build
      - run: pnpm -F desktop tauri build --no-bundle --target aarch64-apple-darwin --config ./src-tauri/tauri.conf.staging.json --features devtools,automation
        env:
          CI: false
      - uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: release
      - run: |
          BINARY_PATH="${{ github.workspace }}/apps/desktop/src-tauri/target/aarch64-apple-darwin/release/hyprnote-staging"
          echo "APP_BINARY_PATH=${BINARY_PATH}" >> $GITHUB_ENV
          mkdir -p "${{ github.workspace }}/e2e/blackbox/logs"
          echo "E2E_LOGS_DIR=${{ github.workspace }}/e2e/blackbox/logs" >> $GITHUB_ENV
      - id: e2e-test
        run: |
          pnpm -F e2e-blackbox e2e 2>&1 | tee "${{ env.E2E_LOGS_DIR }}/e2e-test-output.log"
          exit ${PIPESTATUS[0]}
        env:
          APP_BINARY_PATH: ${{ env.APP_BINARY_PATH }}
          CN_API_KEY_WEBDRIVER: ${{ secrets.CN_API_KEY_WEBDRIVER }}
        continue-on-error: true
      - if: steps.e2e-test.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-blackbox-artifacts-macos
          path: |
            ${{ github.workspace }}/e2e/blackbox/logs/
            ${{ github.workspace }}/e2e/blackbox/videos/
          retention-days: 7
          if-no-files-found: ignore
      - if: steps.e2e-test.outcome == 'failure'
        run: exit 1
