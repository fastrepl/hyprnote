name: Wait for Netlify preview
description: Set BASE_URL to the Netlify deploy-preview URL and wait until it is ready
runs:
  using: composite
  steps:
    - name: Set BASE_URL and wait for Netlify preview
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" != "pull_request" ]]; then
          echo "Not a pull_request event; skipping Netlify preview wait."
          exit 0
        fi

        url="https://deploy-preview-${{ github.event.pull_request.number }}--char.netlify.app"
        echo "BASE_URL=$url" >> "$GITHUB_ENV"

        echo "Waiting for $url to be ready..."
        for i in {1..60}; do
          if curl -sSf "$url" > /dev/null 2>&1; then
            echo "Preview is ready"
            exit 0
          fi
          echo "Not ready yet, sleeping... (attempt $i/60)"
          sleep 10
        done

        echo "Timed out waiting for Netlify preview"
        exit 1
