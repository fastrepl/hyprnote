on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: update-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  permission:
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        uses: ./.github/actions/check-permission
        with:
          user: ${{ github.event.comment.user.login }}
          allowed-users: yujonglee|ComputelessComputer

  rebase:
    needs: permission
    if: needs.permission.outputs.allowed == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4
      - id: parse
        env:
          COMMENT: ${{ github.event.comment.body }}
        run: |
          [[ "$COMMENT" =~ (^|[[:space:]])/update($|[[:space:]]) ]] || { echo "valid=false" >> $GITHUB_OUTPUT; exit 0; }
          echo "valid=true" >> $GITHUB_OUTPUT
      - if: steps.parse.outputs.valid == 'true'
        uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ github.event.comment.id }}
          reaction: eyes
      - if: steps.parse.outputs.valid == 'true'
        id: rebase
        run: |
          IS_PR="${{ github.event.issue.pull_request }}"
          if [ -z "$IS_PR" ]; then
            echo "success=false" >> $GITHUB_OUTPUT
            echo "message=Not a pull request" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_DATA=$(gh api repos/$REPO/pulls/${{ github.event.issue.number }})
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')

          RESPONSE=$(gh api repos/$REPO/pulls/${{ github.event.issue.number }}/update-branch \
            -X PUT \
            -f expected_head_sha="$HEAD_SHA" \
            -f update_method="rebase" 2>&1) || {
            echo "success=false" >> $GITHUB_OUTPUT
            echo "message=$RESPONSE" >> $GITHUB_OUTPUT
            exit 0
          }

          echo "success=true" >> $GITHUB_OUTPUT
          NEW_SHA=$(echo "$RESPONSE" | jq -r '.sha // empty')
          echo "new_sha=$NEW_SHA" >> $GITHUB_OUTPUT
      - if: steps.parse.outputs.valid == 'true' && steps.rebase.outputs.success == 'true'
        uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ github.event.comment.id }}
          reaction: "+1"
      - if: steps.parse.outputs.valid == 'true' && steps.rebase.outputs.success != 'true'
        uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ github.event.comment.id }}
          reaction: confused
