on:
  workflow_dispatch:
  push:
    paths:
      - "apps/restate/**"
    branches:
      - main

jobs:
  deploy:
    runs-on: depot-ubuntu-24.04-8
    timeout-minutes: 60
    concurrency: restate-cloudflare-deploy
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: apps/restate
          packageManager: pnpm
          command: versions upload --message "commit ${{ github.sha }}"
      - uses: ./.github/actions/infisical_export
        id: secrets
        with:
          token: ${{ secrets.INFISICAL_TOKEN }}
          project-id: ${{ secrets.INFISICAL_PROJECT_ID }}
          env: prod
          folder: /restate
      - id: sync-secrets
        working-directory: apps/restate
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          SECRETS_FILE: ${{ steps.secrets.outputs.secrets_file }}
        run: |
          set -euo pipefail

          SECRET_OUTPUT=$(npx wrangler versions secret bulk "$SECRETS_FILE" --message "secrets for commit ${{ github.sha }}" 2>&1)
          rm -f "$SECRETS_FILE"
          echo "$SECRET_OUTPUT"

          VERSION_ID=$(echo "$SECRET_OUTPUT" | grep -oP 'Created version \K[a-f0-9-]+' || true)

          if [ -z "$VERSION_ID" ]; then
            echo "::error::Failed to parse version ID from wrangler secret bulk output"
            exit 1
          fi

          SHORT_VERSION_ID=$(echo "$VERSION_ID" | cut -c1-8)
          DEPLOYMENT_URL="https://${SHORT_VERSION_ID}-hypr-restate.fastrepl.workers.dev"

          echo "version-id=$VERSION_ID" >> $GITHUB_OUTPUT
          echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
      - working-directory: apps/restate
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler versions deploy ${{ steps.sync-secrets.outputs.version-id }}@100% --yes
      - env:
          RESTATE_ADMIN_URL: ${{ secrets.RESTATE_ADMIN_URL }}
          RESTATE_AUTH_TOKEN: ${{ secrets.RESTATE_AUTH_TOKEN }}
        run: npx -y @restatedev/restate deployment register -y ${{ steps.sync-secrets.outputs.deployment-url }}
