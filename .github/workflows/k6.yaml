on:
  workflow_dispatch:
    inputs:
      test_duration:
        description: "Test duration (e.g., 1h, 2h)"
        default: "1h"
      vus:
        description: "Number of virtual users"
        default: "30"

jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - run: flyctl deploy --config apps/api/fly.toml --app hyprnote-api-loadtest --strategy immediate --wait-timeout 120
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - run: flyctl scale count 2 --app hyprnote-api-loadtest --yes
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - uses: grafana/setup-k6-action@v1

      - run: k6 run apps/k6/scripts/stt-live.js
        env:
          API_URL: wss://hyprnote-api-loadtest.fly.dev
          AUTH_TOKEN: ${{ secrets.K6_AUTH_TOKEN }}
          TEST_DURATION: ${{ inputs.test_duration }}
          VUS: ${{ inputs.vus }}
          FLY_ORG: ${{ secrets.FLY_ORG }}
          FLY_APP: hyprnote-api-loadtest
          FLY_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-report-${{ github.run_id }}
          path: stt-live-*.json
          retention-days: 90

      - run: flyctl scale count 0 --app hyprnote-api-loadtest --yes
        if: always()
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
