on:
  workflow_dispatch:

jobs:
  compute-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - run: git fetch --tags --force
      - uses: ./.github/actions/doxxer_install
      - id: version
        run: |
          VERSION=$(doxxer --config doxxer.web.toml next patch)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Computed version: $VERSION"

  deploy:
    needs: compute-version
    runs-on: depot-ubuntu-24.04-8
    timeout-minutes: 60
    concurrency: web-netlify-deploy
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/pnpm_install
      - uses: denoland/setup-deno@v2
      - run: pnpm -F ui build
      - run: pnpm -F web build
        env:
          VITE_APP_URL: "https://char.com"
          VITE_APP_VERSION: ${{ needs.compute-version.outputs.version }}
      - run: npm install -g netlify-cli
      - run: netlify deploy --prod --dir=apps/web/dist/client
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  tag:
    needs: [compute-version, deploy]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: web_v${{ needs.compute-version.outputs.version }}
          tag_prefix: ""
