name: Arch Linux Packages

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "Release channel to use"
        required: false
        default: "nightly"
        type: choice
        options:
          - "stable"
          - "nightly"
  release:
    types:
      - published
      - prereleased

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RELEASE_CHANNEL: ${{ github.event_name == 'workflow_dispatch' && inputs.channel || 'nightly' }}
  TAURI_CONF_PATH: ${{ github.event_name == 'workflow_dispatch' && inputs.channel == 'stable' && './apps/desktop/src-tauri/tauri.conf.stable.json' || './apps/desktop/src-tauri/tauri.conf.nightly.json' }}

jobs:
  build-arch-package:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.release && startsWith(github.event.release.tag_name, 'desktop_')) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: "x86_64-unknown-linux-gnu"
            arch: "x86_64"
            features: "stt-openblas,llm-vulkan"
            platform: "linux/amd64"
          # ARM64 builds temporarily disabled - archlinux:latest doesn't support ARM64
          # TODO: Implement ARM64 support using cross-compilation or alternative approach
          # - target: "aarch64-unknown-linux-gnu"
          #   arch: "aarch64"
          #   features: "stt-openblas,llm-vulkan"
          #   platform: "linux/arm64"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate version
        run: |
          # Extract version using jq for robust JSON parsing
          VERSION=$(jq -r '.version' "${{ env.TAURI_CONF_PATH }}")

          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
            echo "Version: $VERSION, Tag name: $TAG_NAME"
            if [[ ! "$TAG_NAME" == *"$VERSION"* ]]; then
              echo "Error: Tag version doesn't match package version"
              exit 1
            fi
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build in Arch Linux container
        run: |
          # Create build script that will run inside the container
          cat > build.sh << 'BUILD_SCRIPT_EOF'
          #!/bin/bash
          set -e
          
          echo "=== Building Hyprnote $VERSION for $ARCH ==="
          
          # Update system and install dependencies
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            base-devel \
            git \
            wget \
            curl \
            file \
            cmake \
            pkgconf \
            openssl \
            gtk3 \
            webkit2gtk-4.1 \
            libappindicator-gtk3 \
            librsvg \
            alsa-lib \
            libpulse \
            openblas \
            cblas \
            vulkan-icd-loader \
            vulkan-headers \
            xdotool \
            xdg-utils \
            unzip \
            clang \
            nodejs \
            npm \
            python \
            python-pip \
            python-poetry
          
          # Install pnpm
          npm install -g pnpm
          
          # Install Rust
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          source "$HOME/.cargo/env"
          rustup target add $RUST_TARGET
          
          # Install protoc
          cd /tmp
          PROTOC_VERSION=25.1
          PROTOC_ARCH=$PROTOC_ARCH_NAME
          wget https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-${PROTOC_ARCH}.zip
          unzip protoc-${PROTOC_VERSION}-linux-${PROTOC_ARCH}.zip -d /usr/local
          chmod +x /usr/local/bin/protoc
          
          # Build the application
          cd /workspace
          
          # Install Node dependencies
          pnpm install
          
          # Install Python dependencies and run pre-build
          poetry install
          poetry run python scripts/pre_build.py
          
          # Compile translations
          pnpm -F desktop lingui:compile
          
          # Build UI package
          pnpm -F ui build
          
          # Find cblas.h location and set environment for build
          CBLAS_LOCATION=$(find /usr/include -name "cblas.h" 2>/dev/null | head -n 1)
          if [ -n "$CBLAS_LOCATION" ]; then
            CBLAS_DIR=$(dirname "$CBLAS_LOCATION")
            echo "Found cblas.h at: $CBLAS_LOCATION (directory: $CBLAS_DIR)"
            export BLAS_INCLUDE_DIRS="$CBLAS_DIR"
          else
            echo "Warning: cblas.h not found, using default /usr/include"
            export BLAS_INCLUDE_DIRS=/usr/include
          fi
          
          export LIBCLANG_PATH=/usr/lib
          export CARGO_LOG=cargo::core::compiler::fingerprint=info
          export RUST_BACKTRACE=1
          
          # Build with Cargo directly
          # Note: We skip Tauri CLI bundling (which creates AppImage/deb/rpm) because
          # AppImage bundling fails on modern Arch due to incompatible strip utility.
          # We only need the binary for our Arch package, so we build with cargo directly.
          echo "=== Starting cargo build ==="
          cd /workspace/apps/desktop/src-tauri
          
          # Build with explicit output capture and error handling
          echo "Running: cargo build --release --target $RUST_TARGET --features $FEATURES"
          if cargo build --release --target $RUST_TARGET --features $FEATURES 2>&1 | tee /tmp/cargo-build.log; then
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
          else
            BUILD_EXIT_CODE=$?
          fi
          
          echo "=== Cargo build exit code: $BUILD_EXIT_CODE ==="
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "❌ Cargo build failed with exit code $BUILD_EXIT_CODE"
            echo "=== Last 100 lines of build log ==="
            tail -n 100 /tmp/cargo-build.log || true
            exit $BUILD_EXIT_CODE
          fi
          
          echo "✅ Cargo build completed successfully"
          
          # Verify binary was built
          BINARY_PATH="/workspace/apps/desktop/src-tauri/target/${RUST_TARGET}/release/hyprnote"
          echo "Checking for binary at: $BINARY_PATH"
          if [ ! -f "$BINARY_PATH" ]; then
            echo "❌ Error: Binary not found at $BINARY_PATH"
            echo "=== Contents of target directory ==="
            ls -la "/workspace/apps/desktop/src-tauri/target/${RUST_TARGET}/release/" || echo "Release directory does not exist"
            echo "=== Last 50 lines of build log ==="
            tail -n 50 /tmp/cargo-build.log || true
            exit 1
          fi
          echo "✅ Binary verified at: $BINARY_PATH"
          ls -lh "$BINARY_PATH"
          
          # Create PKGBUILD directory
          mkdir -p /pkgbuild
          cd /pkgbuild
          
          # Create PKGBUILD
          cat > PKGBUILD << PKGBUILD_EOF
          # Maintainer: Hyprnote Team
          pkgname=hyprnote
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc="AI-powered note-taking and transcription application"
          arch=("${ARCH}")
          url="https://github.com/different-ai/hyprnote"
          license=('custom')
          depends=(
            'webkit2gtk-4.1'
            'gtk3'
            'libappindicator-gtk3'
            'librsvg'
            'openssl'
            'alsa-lib'
            'libpulse'
            'openblas'
            'vulkan-icd-loader'
            'xdotool'
          )
          source=()
          sha256sums=()
          options=('!strip')
          
          package() {
            # Find the binary
            BINARY=\$(find /workspace/apps/desktop/src-tauri/target/${RUST_TARGET}/release -maxdepth 1 -type f -executable -name "hyprnote" | head -n 1)
            
            if [ -z "\$BINARY" ]; then
              echo "Error: Binary not found"
              exit 1
            fi
            
            # Install binary
            install -Dm755 "\$BINARY" "\${pkgdir}/usr/bin/hyprnote"
            
            # Install .desktop file if exists
            DESKTOP_FILE=\$(find /workspace/apps/desktop/src-tauri -name "*.desktop" | head -n 1)
            if [ -n "\$DESKTOP_FILE" ]; then
              install -Dm644 "\$DESKTOP_FILE" "\${pkgdir}/usr/share/applications/hyprnote.desktop"
            fi
            
            # Install icons if they exist
            for size in 32 128 256; do
              ICON=\$(find /workspace/apps/desktop/public -name "\${size}x\${size}.png" -o -name "icon_\${size}x\${size}.png" | head -n 1)
              if [ -n "\$ICON" ]; then
                install -Dm644 "\$ICON" "\${pkgdir}/usr/share/icons/hicolor/\${size}x\${size}/apps/hyprnote.png"
              fi
            done
            
            # Install license
            if [ -f /workspace/LICENSE ]; then
              install -Dm644 /workspace/LICENSE "\${pkgdir}/usr/share/licenses/\${pkgname}/LICENSE"
            fi
          }
          PKGBUILD_EOF
          
          # Build package as non-root user
          useradd -m builder
          chown -R builder:builder /pkgbuild
          chown -R builder:builder /workspace
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          su - builder -c "cd /pkgbuild && makepkg --noconfirm --skippgpcheck --nosign"
          
          # Copy package to output
          cp /pkgbuild/*.pkg.tar.zst /output/
          
          echo "=== Build completed successfully ==="
          BUILD_SCRIPT_EOF
          
          chmod +x build.sh
          
          # Determine protoc architecture name
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            PROTOC_ARCH_NAME="x86_64"
          else
            PROTOC_ARCH_NAME="aarch64"
          fi
          
          # Run build in Docker container with appropriate platform
          mkdir -p "${GITHUB_WORKSPACE}/output"
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -v "${GITHUB_WORKSPACE}/output:/output" \
            -v "${GITHUB_WORKSPACE}/build.sh:/build.sh" \
            -e VERSION="${{ env.VERSION }}" \
            -e ARCH="${{ matrix.arch }}" \
            -e RUST_TARGET="${{ matrix.target }}" \
            -e FEATURES="${{ matrix.features }}" \
            -e TAURI_CONF="${{ env.TAURI_CONF_PATH }}" \
            -e PROTOC_ARCH_NAME="$PROTOC_ARCH_NAME" \
            -e CI="false" \
            -e GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}" \
            -e POSTHOG_API_KEY="${{ secrets.POSTHOG_API_KEY }}" \
            -e SENTRY_DSN="${{ secrets.SENTRY_DSN }}" \
            -e KEYGEN_ACCOUNT_ID="${{ secrets.KEYGEN_ACCOUNT_ID }}" \
            -e KEYGEN_VERIFY_KEY="${{ secrets.KEYGEN_VERIFY_KEY }}" \
            -e TAURI_SIGNING_PRIVATE_KEY="${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" \
            -e TAURI_SIGNING_PRIVATE_KEY_PASSWORD="${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" \
            archlinux:latest \
            /bin/bash /build.sh

      - name: Find package file
        id: find-pkg
        run: |
          PKG_PATH=$(find "${GITHUB_WORKSPACE}/output" -name "*.pkg.tar.zst" | head -n 1)
          if [ -z "$PKG_PATH" ]; then
            echo "Error: No package file found"
            exit 1
          fi
          echo "pkg_path=$PKG_PATH" >> $GITHUB_OUTPUT
          echo "pkg_name=$(basename $PKG_PATH)" >> $GITHUB_OUTPUT
          echo "Found package: $PKG_PATH"

      - name: Test package installation
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          echo "Testing Arch package installation..."

          # Run test in Docker container
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "${{ steps.find-pkg.outputs.pkg_path }}:/package.pkg.tar.zst" \
            archlinux:latest \
            /bin/bash -c "
              # Install the package
              pacman -Syu --noconfirm
              pacman -U --noconfirm /package.pkg.tar.zst

              # Verify installation
              pacman -Q hyprnote

              # Check if binary exists and is executable
              if [ -f /usr/bin/hyprnote ]; then
                echo 'Found binary: /usr/bin/hyprnote'
                file /usr/bin/hyprnote
                ldd /usr/bin/hyprnote || true
                echo 'Binary verification successful'
              else
                echo 'Error: Binary not found'
                exit 1
              fi

              # Verify .desktop file
              DESKTOP_FILE=\$(find /usr/share/applications -name '*hyprnote*.desktop' 2>/dev/null | head -n 1)
              if [ -n \"\$DESKTOP_FILE\" ]; then
                echo \"Found .desktop file: \$DESKTOP_FILE\"
                cat \"\$DESKTOP_FILE\"
              else
                echo 'Warning: .desktop file not found'
              fi

              echo '✅ Arch package installation test passed'
            "

      - name: Verify package (cross-compiled ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          echo "Verifying ARM64 Arch package structure..."

          # Extract and verify package
          mkdir -p /tmp/pkg-test
          cd /tmp/pkg-test
          tar -xf "${{ steps.find-pkg.outputs.pkg_path }}"

          # List contents
          ls -la

          # Find and verify binary architecture
          if [ -f usr/bin/hyprnote ]; then
            echo "Found binary: usr/bin/hyprnote"
            file usr/bin/hyprnote | grep -i "aarch64\|ARM"
            if [ $? -eq 0 ]; then
              echo "✅ Binary is correctly compiled for ARM64"
            else
              echo "❌ Binary architecture mismatch"
              file usr/bin/hyprnote
              exit 1
            fi
          else
            echo "❌ No binary found in package"
            exit 1
          fi

          # Verify .desktop file
          DESKTOP_FILE=$(find usr/share/applications -name "*.desktop" 2>/dev/null | head -n 1)
          if [ -n "$DESKTOP_FILE" ]; then
            echo "Found .desktop file: $DESKTOP_FILE"
            cat "$DESKTOP_FILE"
          fi

          echo "✅ ARM64 Arch package verification passed"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: hyprnote-${{ env.VERSION }}-${{ matrix.arch }}.pkg.tar.zst
          path: ${{ steps.find-pkg.outputs.pkg_path }}
          if-no-files-found: error

      - name: Upload package to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find-pkg.outputs.pkg_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
