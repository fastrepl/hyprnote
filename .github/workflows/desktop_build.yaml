on:
  workflow_call:
    inputs:
      platform:
        description: "Build platform (linux or macos)"
        required: true
        type: string
      target:
        description: "Rust target triple"
        required: true
        type: string
      channel:
        description: "Release channel (staging, nightly, stable)"
        required: true
        type: string
      bundles:
        description: "Bundle types to build (e.g., appimage,deb). Leave empty for --no-bundle"
        required: false
        type: string
        default: ""
      features:
        description: "Cargo features to enable (e.g., devtools,automation)"
        required: false
        type: string
        default: ""
      version:
        description: "App version"
        required: false
        type: string
        default: "0.0.0"
      run_e2e:
        description: "Whether to run E2E tests after build"
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ${{ inputs.platform == 'linux' && 'depot-ubuntu-24.04-8' || 'depot-macos-14' }}
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: ./.github/actions/install_desktop_deps
        with:
          target: ${{ inputs.platform }}

      - uses: ./.github/actions/rust_install
        with:
          platform: ${{ inputs.platform }}

      - uses: ./.github/actions/pnpm_install

      - run: pnpm -F ui build

      - id: build
        run: |
          BUNDLES_FLAG="--no-bundle"
          if [[ -n "${{ inputs.bundles }}" ]]; then
            BUNDLES_FLAG="--bundles ${{ inputs.bundles }}"
          fi

          FEATURES_FLAG=""
          if [[ -n "${{ inputs.features }}" ]]; then
            FEATURES_FLAG="--features ${{ inputs.features }}"
          fi

          TAURI_CONF_PATH="./src-tauri/tauri.conf.${{ inputs.channel }}.json"

          pnpm -F desktop tauri build $BUNDLES_FLAG --target ${{ inputs.target }} --config $TAURI_CONF_PATH $FEATURES_FLAG
        env:
          CI: false
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AM_API_KEY: ${{ secrets.AM_API_KEY }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          APP_VERSION: ${{ inputs.version }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_APP_URL: "https://hyprnote.com"
          VITE_AI_URL: "https://ai.hyprnote.com"
          VITE_API_URL: "https://api.hyprnote.com"
          VITE_PRO_PRODUCT_ID: ${{ secrets.VITE_PRO_PRODUCT_ID }}
          VITE_APP_VERSION: ${{ inputs.version }}

      - if: ${{ inputs.run_e2e && inputs.platform == 'linux' }}
        uses: ./.github/actions/desktop-e2e-linux
        with:
          channel: ${{ inputs.channel }}
          target_triple: ${{ inputs.target }}

      - if: ${{ inputs.run_e2e && inputs.platform == 'macos' }}
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: release

      - if: ${{ inputs.run_e2e && inputs.platform == 'macos' }}
        run: |
          if [[ "${{ inputs.channel }}" == "staging" ]]; then
            BINARY_NAME="hyprnote-staging"
          elif [[ "${{ inputs.channel }}" == "nightly" ]]; then
            BINARY_NAME="hyprnote-nightly"
          else
            BINARY_NAME="hyprnote"
          fi
          BINARY_PATH="${{ github.workspace }}/apps/desktop/src-tauri/target/${{ inputs.target }}/release/${BINARY_NAME}"
          echo "APP_BINARY_PATH=${BINARY_PATH}" >> $GITHUB_ENV
          mkdir -p "${{ github.workspace }}/e2e/blackbox/logs"
          echo "E2E_LOGS_DIR=${{ github.workspace }}/e2e/blackbox/logs" >> $GITHUB_ENV

      - if: ${{ inputs.run_e2e && inputs.platform == 'macos' }}
        id: e2e-test-macos
        run: |
          pnpm -F e2e-blackbox e2e 2>&1 | tee "${{ env.E2E_LOGS_DIR }}/e2e-test-output.log"
          exit ${PIPESTATUS[0]}
        env:
          APP_BINARY_PATH: ${{ env.APP_BINARY_PATH }}
          CN_API_KEY_WEBDRIVER: ${{ secrets.CN_API_KEY_WEBDRIVER }}
        continue-on-error: true

      - if: ${{ inputs.run_e2e && inputs.platform == 'macos' && steps.e2e-test-macos.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: e2e-blackbox-artifacts-macos
          path: |
            ${{ github.workspace }}/e2e/blackbox/logs/
            ${{ github.workspace }}/e2e/blackbox/videos/
          retention-days: 7
          if-no-files-found: ignore

      - if: ${{ inputs.run_e2e && inputs.platform == 'macos' && steps.e2e-test-macos.outcome == 'failure' }}
        run: exit 1
