on:
  workflow_call:
    inputs:
      ref:
        required: false
        type: string
      issue_number:
        required: true
        type: number
      comment_id:
        required: true
        type: number

concurrency:
  group: staging-${{ inputs.issue_number }}
  cancel-in-progress: true

jobs:
  resolve-and-trigger:
    runs-on: ubuntu-latest
    outputs:
      data: ${{ steps.result.outputs.data }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ inputs.comment_id }}
          reaction: eyes
      - id: resolve
        run: |
          EXPLICIT_REF="${{ inputs.ref }}"

          output_ref() {
            echo "ref=$1" >> $GITHUB_OUTPUT
            echo "sha=$2" >> $GITHUB_OUTPUT
            echo "branch=$3" >> $GITHUB_OUTPUT
            echo "needs_cleanup=$4" >> $GITHUB_OUTPUT
          }

          if [ -z "$EXPLICIT_REF" ]; then
            PR_DATA=$(gh api repos/$REPO/pulls/${{ inputs.issue_number }} 2>/dev/null) || {
              echo "error=Not a pull request" >> $GITHUB_OUTPUT
              exit 0
            }
            BRANCH=$(echo "$PR_DATA" | jq -r '.head.ref')
            SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
            output_ref "$BRANCH" "$SHA" "$BRANCH" "false"
          else
            SHA=$(gh api repos/$REPO/commits/$EXPLICIT_REF --jq '.sha')
            if gh api repos/$REPO/git/refs/heads/$EXPLICIT_REF --jq '.ref' >/dev/null 2>&1; then
              output_ref "$EXPLICIT_REF" "$SHA" "$EXPLICIT_REF" "false"
            else
              TEMP_BRANCH="staging-temp-${SHA:0:8}"
              GH_TOKEN=${{ secrets.YUJONGLEE_GITHUB_TOKEN_REPO }} gh api repos/$REPO/git/refs -f ref="refs/heads/$TEMP_BRANCH" -f sha="$SHA"
              output_ref "$EXPLICIT_REF" "$SHA" "$TEMP_BRANCH" "true"
            fi
          fi
      - if: steps.resolve.outputs.error == ''
        id: trigger
        uses: ./.github/actions/trigger-workflow
        with:
          workflow: desktop_cd.yaml
          ref: ${{ steps.resolve.outputs.branch }}
          channel: staging
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          max_attempts: "6"
      - id: result
        run: |
          BRANCH="${{ steps.resolve.outputs.branch }}"
          SHA="${{ steps.resolve.outputs.sha }}"
          RUN_ID="${{ steps.trigger.outputs.run_id }}"
          ERROR="${{ steps.resolve.outputs.error }}"

          if [ -n "$ERROR" ]; then
            DATA=$(jq -cn \
              --arg status "$ERROR" \
              '[{header: "Status", value: $status}]')
          elif [ -n "$RUN_ID" ]; then
            DATA=$(jq -cn \
              --arg branch "[\`$BRANCH\`](https://github.com/$REPO/tree/$BRANCH)" \
              --arg sha "[\`${SHA:0:8}\`](https://github.com/$REPO/commit/$SHA)" \
              --arg status "[View](https://github.com/$REPO/actions/runs/$RUN_ID)" \
              '[{header: "Branch", value: $branch}, {header: "Commit", value: $sha}, {header: "Status", value: $status}]')
          else
            DATA=$(jq -cn \
              --arg branch "[\`$BRANCH\`](https://github.com/$REPO/tree/$BRANCH)" \
              --arg sha "[\`${SHA:0:8}\`](https://github.com/$REPO/commit/$SHA)" \
              --arg status "[Logs](https://github.com/$REPO/actions/runs/${{ github.run_id }})" \
              '[{header: "Branch", value: $branch}, {header: "Commit", value: $sha}, {header: "Status", value: $status}]')
          fi
          echo "data=$DATA" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/comment-result
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          issue_number: ${{ inputs.issue_number }}
          data: ${{ steps.result.outputs.data }}
      - if: steps.resolve.outputs.needs_cleanup == 'true'
        env:
          GH_TOKEN: ${{ secrets.YUJONGLEE_GITHUB_TOKEN_REPO }}
        run: gh api repos/${{ github.repository }}/git/refs/heads/${{ steps.resolve.outputs.branch }} -X DELETE || true
