name: "Install Rust Toolchain"
description: "Installs Rust toolchain with platform-specific targets using moonrepo/setup-rust"

inputs:
  platform:
    description: "Target platform (macos, ios, android, windows, linux)"
    required: false
    default: ""
  cache-target:
    description: "Target profile to cache (debug or release)"
    required: false
    default: "debug"
  cache-base:
    description: "Base branch for warmup cache strategy"
    required: false
    default: "main"

runs:
  using: "composite"
  steps:
    - name: Determine targets for platform
      id: targets
      shell: bash
      run: |
        TARGETS=""
        if [[ "${{ inputs.platform }}" == "macos" ]]; then
          TARGETS="aarch64-apple-darwin,x86_64-apple-darwin"
        elif [[ "${{ inputs.platform }}" == "ios" ]]; then
          TARGETS="aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim"
        elif [[ "${{ inputs.platform }}" == "android" ]]; then
          TARGETS="aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android"
        elif [[ "${{ inputs.platform }}" == "windows" ]]; then
          TARGETS="x86_64-pc-windows-msvc"
        elif [[ "${{ inputs.platform }}" == "linux" ]]; then
          TARGETS="x86_64-unknown-linux-gnu,x86_64-unknown-linux-musl,aarch64-unknown-linux-gnu"
        fi
        echo "targets=$TARGETS" >> $GITHUB_OUTPUT

    - name: Setup Rust with moonrepo/setup-rust
      uses: moonrepo/setup-rust@v1
      with:
        targets: ${{ steps.targets.outputs.targets }}
        cache: true
        cache-target: ${{ inputs.cache-target }}
        cache-base: ${{ inputs.cache-base }}
        bins: ${{ inputs.platform == 'windows' && 'trusted-signing-cli' || '' }}
        target-dirs: target,apps/desktop/src-tauri/target
      env:
        GITHUB_TOKEN: ${{ github.token }}

    - name: Install Linux dependencies
      if: inputs.platform == 'linux'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu libasound2-dev
