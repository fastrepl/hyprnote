on:
  workflow_dispatch:

jobs:
  compute-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - run: git fetch --tags --force
      - uses: ./.github/actions/doxxer_install
      - id: version
        run: |
          VERSION=$(doxxer --config doxxer.ai.toml next patch)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Computed version: $VERSION"

  build:
    needs: compute-version
    runs-on: depot-ubuntu-24.04-8
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/rust_install
        with:
          platform: linux
      - run: |
          cargo build --release -p ai
          objcopy --only-keep-debug target/release/ai target/release/ai.debug
          objcopy --strip-debug --strip-unneeded target/release/ai
          objcopy --add-gnu-debuglink=target/release/ai.debug target/release/ai
        env:
          CARGO_PROFILE_RELEASE_DEBUG: "true"
      - uses: actions/upload-artifact@v4
        with:
          name: ai-binary
          path: target/release/ai
          retention-days: 1
      - uses: actions/upload-artifact@v4
        with:
          name: ai-debug
          path: target/release/ai.debug
          retention-days: 1

  sentry-upload:
    needs: [compute-version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ai-debug
          path: ./debug
      - uses: ./.github/actions/sentry_cli
      - run: sentry-cli debug-files upload --include-sources ./debug
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

  deploy:
    needs: [compute-version, build, sentry-upload]
    runs-on: depot-ubuntu-24.04-8
    timeout-minutes: 60
    concurrency: ai-fly-deploy
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ai-binary
          path: ./apps/ai/bin
      - run: chmod +x ./apps/ai/bin/ai
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --config apps/ai/fly.toml --dockerfile apps/ai/Dockerfile --remote-only -e APP_VERSION=${{ needs.compute-version.outputs.version }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  tag:
    needs: [compute-version, deploy]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: ai_v${{ needs.compute-version.outputs.version }}
          tag_prefix: ""
