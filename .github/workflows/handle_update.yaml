on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: number
      comment_id:
        required: true
        type: number

concurrency:
  group: update-${{ inputs.issue_number }}
  cancel-in-progress: true

jobs:
  rebase:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ inputs.comment_id }}
          reaction: eyes
      - id: rebase
        run: |
          PR_DATA=$(gh api repos/$REPO/pulls/${{ inputs.issue_number }} 2>/dev/null) || {
            echo "success=false" >> $GITHUB_OUTPUT
            echo "message=Not a pull request" >> $GITHUB_OUTPUT
            exit 0
          }

          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')

          RESPONSE=$(gh api repos/$REPO/pulls/${{ inputs.issue_number }}/update-branch \
            -X PUT \
            -f expected_head_sha="$HEAD_SHA" \
            -f update_method="rebase" 2>&1) || {
            echo "success=false" >> $GITHUB_OUTPUT
            echo "message=$RESPONSE" >> $GITHUB_OUTPUT
            exit 0
          }

          echo "success=true" >> $GITHUB_OUTPUT
          NEW_SHA=$(echo "$RESPONSE" | jq -r '.sha // empty')
          echo "new_sha=$NEW_SHA" >> $GITHUB_OUTPUT
      - if: steps.rebase.outputs.success == 'true'
        uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ inputs.comment_id }}
          reaction: "+1"
      - if: steps.rebase.outputs.success != 'true'
        uses: ./.github/actions/add-reaction
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repo: ${{ github.repository }}
          comment: ${{ inputs.comment_id }}
          reaction: confused
